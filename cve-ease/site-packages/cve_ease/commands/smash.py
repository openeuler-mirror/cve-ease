# -*- coding: utf-8 -*-

"""
 (c) 2023 - Copyright CTyunOS Inc

 Authors:
   youyifeng <youyf2@chinatelecom.cn>

"""

import logging
from optparse import OptionParser

from cve_ease import activate_session
from cve_ease.models import CVELOG, SALOG

logger = logging.getLogger('cve-ease')


def get_usage_str(usage):
    return usage + "\n(Specify the --help global option for a list of other help options)"


def handle_smash(gconfig, db_session, args):
    """[test] Smash test tool"""
    usage = "usage: %prog smash <options>"
    parser = OptionParser(usage=get_usage_str(usage))

    parser.add_option('-i', '--info', dest='info', default="ALL",
                      help='smash specific info')

    (options, args) = parser.parse_args(args)

    session = activate_session(db_session, gconfig)
    logger.debug(" * active sql session")

    # for test
    # last_sa_record.securityNoticeList = last_sa_record.securityNoticeList.replace('openEuler-SA-2023-1065',
    #                                                                               'openEuler-SA-9999-8888')
    # last_sa_record.securityNoticeList = last_sa_record.securityNoticeList.replace('openEuler-SA-2023-1146',
    #                                                                               'openEuler-SA-3999-3888')
    def cve_smash():
        #  cve-ease -d daemon && cve-ease -d smash -i cve && cve-ease -d daemon
        #  cve-ease -d daemon && cve-ease -d smash -i sa && cve-ease -d daemon
        total = session.query(CVELOG).count()
        print("cve log total record :", total)
        if 0 == total:
            print(" WARNNING: no cve cache found! you should run 'cve-ease cve -m' to cache it.")
            return
        last_cve_record = session.query(CVELOG).order_by(CVELOG.id.desc()).first()
        last_cve_record.cveDatabaseList = last_cve_record.cveDatabaseList.replace('openssh', 'sshopen')
        session.commit()
        print("cve latest log smash done!")

    def sa_smash():
        total = session.query(SALOG).count()
        print("sa log total record :", total)
        if 0 == total:
            print(" WARNNING: no sa cache found! you should run 'cve-ease sa -m' to cache it.")
            return
        last_sa_record = session.query(SALOG).order_by(SALOG.id.desc()).first()
        last_sa_record.securityNoticeList = last_sa_record.securityNoticeList.replace('ssh', 'hss')
        session.commit()
        print("sa latest log smash done!")

    if options.info:
        if "cve" == options.info:
            cve_smash()
        elif "sa" == options.info:
            sa_smash()
        else:
            cve_smash()
            sa_smash()
        print(" do smash done!")
    else:
        parser.print_help()
